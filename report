5/3/2017 5:36:43 PM     C:\code\report
 
fix: jenkins .metadata directory delete prior to build
     remove PRINT_FLOAT
     #ifdef Common\System_Log.c non-flight code
     build 3 systems
     test SVN spewtom on RELEASE build - load and run to verify
     start PR 4475 & 4476

Short Term Goals:
    Merge outstanding code to DevBr: 
        [done] PR 1246: Inner Loop gains don't work at all airspeeds
        [done] PR 4474: Coefficient Mgmt & Monitors
        [    ] PR 4475: Tool fixes -> no CCB required, only code review
        [done] PR 4476: PRINTF macros & fault string compression & svn ver ident
        [    ] PR 4477: Outer Loop changes
    [ ] MCP Override detection - prep hardware -> OL38_OverDet
    [ ] (Emily) Get Hardware to Emily (need to build 2 systems: Emily & Sim)
    [ ] (Emily) Ambient light sensor driver
    [ ] (Emily) Auto Dimmer Control (using ambient light data)
    [ ] I2C-RS485 Driver (init only)
        ->  Test RS485 ? master: slave1, slave2
    [ ] Update Magnetometer driver
    [ ] Update OAT driver
    [ ] USB-SPI-CAN converter driver
        ->  CAN/USB link - MCP 25625
            ==> Table 3-3: setting up the CNF1..3 registers (baud = 1Mb)
            a. check CAN settings in MX app : baud rate
            b. check CAN settings on HAP    : baud rate
    [ ] Autogen post-build config report
Long term goals:
    [ ] Brown Bag presentation: HAP cross train
    [ ] Bring in intern and make them productive
    [ ] Update requirements for Attitude Control block (Inner Loop)
    [ ] All software requirements completed
    [ ] Resolve all Software PRs

CPD:
    1. Calibration magnetometer
    2. Fix ADAHRS initialization
    3. Prep tools
        a. Cyclic tracking
        b. Map
        c. Collective tracking
        d. Align HAP frames with cpd trigger data
        e. Do a dry run

HAP Total:
    ->  External ADC stick pin shuffle
    ->  Sim mod plan?
    ->  4 segment personality file loader.


./branches/bartb --- see differences GainScheduling vs DevBr
    [20516] GainScheduling (from /bartb/FTC_FineTuning_v2)

        **** (PR 4477) Outer Loop changes ****
        [LF] Roll_Target_Gen.c 
            integrator saturation flag outer loop : st_ptr->state.integ_sat
        [LF] Bias_Calc.c spd_sat flag in outer loop
            Add speed upper and lower saturation flags to limit the sustained and pulsed fore and aft rates.
        [***] Roll_Control.c psi_dot_error bug in calculation - outer loop
            Fix calculation of psi_dot_error for PI proportional and integral terms for Roll control.

        **** (PR 4475) Tool fixes ****
        [ ] Fixed MaintenanceDisplay build DLL copy
        [ ] Fixed MaintenanceDisplay magnetometer calibration DLL
        [ ] fixed ADP & MCP personality make file
            SWDev\ADP\Project\ADP_CCS_Target\.cproject
        [ ] Tools - In_Flight_Tools\AttitudeIndicator2 -> limit flags and condensed interface
        [ ] C:\helitrak\HdgHoldProf\SWDev\Tools\Non_Flight_Code\Source\Common\Profiling.c/.h

   ==>  [ ] add jenkins .metadata directory delete prior to build CCSBuild.bat

Updates
=======
[ ] 09. ADP/MCP pin outs
[ ] 08. BID fifo [alpha, beta]
        A => FIFO BID_FIFO_TX_Space_Avail look at alpha
        B => FIFO BID_FIFO_TX_Space_Avail look at beta
        A => FIFO BID_FIFO_Write writes to alpha
        B => FIFO BID_FIFO_Write writes to beta
        A => FIFO BID_FIFO_Read reads from beta
        B => FIFO BID_FIFO_Read reads from alpha
        A => FIFO BID_FIFO_RX_Bytes_Avail look at beta
        B => FIFO BID_FIFO_RX_Bytes_Avail look at alpha
[ ] 12. finish CANIO
[ ] 01. code space idea => move POST into NVRAM since executed once
[ ] 02. fix coeff mgr register - can't use pointer (Personality != Fltcode) so offset_of
[ ] 07. Request/Response App to A/P for strings, etc...
[ ] 08. 4 segment personality file loader.


List of tasks since???
======================
Attitude indicator: 
    [x] format airspeed only needs 0 dec, angles 1 decimal, squeeze controls closer
    [ ] label refresh occasionally - every 30 seconds
    [ ] packet protocol: preamble 0xfe | cmd | len| data | crc => binary data
    [ ] show value in coeff chgr
    [ ] make array of buttons etc...
Coefficient App:
    [ ] Add tab -> step inputs see diagram => CoeffChanger3 => flesh out
    [ ] don't allow coefficients to load if A/P engaged
        [ ] ADP
        [x] MCP
    [x] combine coefficients for MCPs into one
    [ ] print saturation limits
    [ ] auto reload of coefficients
    [x] fix float extra digit
    [x] add test ports (blocks) - disable ADP via zero gains using coeff mgr

coeff loader needs to error out if file size is wrong
install SMTP
verify VNE table
add string segment to personality file
only build/load coeff segment
runtime warning of missing segment(s)
eliminate PWM monitor
CRC's design


Top shelf:
=========
[ ] sat/rate_lim -> Attitude Indicator.
    DevBr_PitchMods_Merge_Ver2 => AttitudeIndicator2

[ ] MCP Coeff changer -> after condensing strings :::: broken build macros => OK in HdgHoldProf
    DevBr_PitchMods_Merge_Ver2 => Coeff_Mgmt_Test.c, CoeffChanger

[ ] PR_3576: add print macros to src 

Jumpstart:
=========
[ ] Need saturation and rate limit flags in Telemetry and Attitude Indicator.
[ ] Place constants and strings into coefficient file and free up executable space.
[+] Update unit tests for new pitch inner loop & ADAHRS
[+] Automate Matlab coefficient builder
[+] Maintenance Application needs to display selectable raw sensor data
[+] Create system timing profmap to baseline for regression testing - prof.inc
[?] Stack Monitoring - stack.inc (global int call_depth)
[?] Automate Flight Test Data Analysis

remember: http://processors.wiki.ti.com/index.php/Project_Macros for CCS

Merging HdgHold to DevBr: [M:\prj\prs\HdgHoldMerge]
========================

[1376] Altitude Env Prot: Revs(18079 -> 19354 -> 20186) : C:\helitrak\PR1376_Merge
    http://hltrk-bugzilla01/show_bug.cgi?id=1376
    Altitude Hold Envelope Protection (previously known as Heading-only mode)
    [x] File list - [x] WAS/IS - [ ] zips to PR [ ] Peer Rvw - [ ] CCB Q - [ ] Needs Rqmts
[4045] HAP_unit_test.h => HAP1_Unit_Test.h is incompatible with Visual Studio 2013 and greater
    http://hltrk-bugzilla01/show_bug.cgi?id=4045
    HAP1_Unit_Test.h is incompatible with Visual Studio 2013 and greater
    [x] File list - [x] WAS/IS - [ ] zips to PR [ ] Peer Rvw - [ ] CCB Q - [ ] Needs Rqmts
[3818] Fault_Enum literals
    http://hltrk-bugzilla01/show_bug.cgi?id=3818
    SHOW_FAULT_ENUMS option is not printing the enum string in all cases 
    [x] File list - [x] WAS/IS - [ ] zips to PR [ ] Peer Rvw - [ ] CCB Q - [ ] Needs Rqmts
[4046] Fixed button control logic
    http://hltrk-bugzilla01/show_bug.cgi?id=4046
    User input bit flags erroneously being treated as values instead of bitfields.
    [x] File list - [x] WAS/IS - [ ] zips to PR [ ] Peer Rvw - [ ] CCB Q - [ ] Needs Rqmts
[3576] SVN version CAN spew -> done in PR 4476
    => M:\prj\prs\HdgHold_HdgHoldProf_Merge: 3576.diff needs engrg to clean branch and merged.
    http://hltrk-bugzilla01/show_bug.cgi?id=3576
    In DEBUG builds, need to print branch identifier to CAN bus.
    [x] File list - [x] WAS/IS - [ ] update headers - [ ] zips to PR [ ] Peer Rvw - [ ] CCB Q

**********************************************************************

Extras:
======
[ ] Coeff builder calculator
[ ] Coeff builder getter
[ ] Coefficient matlab builder
[ ] tracer.c ==> prof.inc
[ ] other stuff in HdgHold and HdgHoldProf    
    ??? ADP\Annunciators_IBIT.c -- light up annunciator, 
    new CAN_DEMUX2
    new build types: coeff builds for all types
    CoeffChanger: now supports MCP
    MaintenanceDisplay: supports scripting

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
summary to do:
[ ] merge mxapp => can_demux POC
[ ] coefficient builder
    C:\helitrak\HdgHold\SimModel\HAP\Autopilot_ARCH_ADP_RollTargetGen_setCfgValues.m
[ ] unit tests: roll control
[ ] ambient light cal: => y:ambient2.ino
    => user input: gain and integration time
[ ] HdgHoldCRC -- OMG debug this
[ ] SP & PP different tones : HdgHoldTone
[ ] LCD STM board - start w/pure demo code, update tool chain
[ ] debug PFM release build on jenkins - works locally on HdgHold
[ ] requirements - diff trunk w/devbr
[ ] rs485 remote mag
[ ] mcp overdet: full hardware support ...
[ ] button cal code support
[ ] dimmer cal code support
[ ] @home p.o.c. WxPython & DLL Mx_App

[ ] vim report gen: :tabnew !ls

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[ ] Goals
    [ ] complete todo list for a/p cert: tools & estimates
    [ ] requirements - diff trunk w/devbr
    [ ] rs485
    [ ] IL test flights to assess need for gain sched: speed/alt/wt => IL tuning
    [ ] use feedback_run w/0 gain for 2nd integrator (pitch)
    [ ] mcp overdet: full hardware support ...
    [ ] ambient light cal: => y:ambient2.ino
        ==> plot curves for each gain
        TSL2591_GAIN_LOW   = 0x00, // low gain (1x)
        TSL2591_GAIN_MED   = 0x10, // medium gain (25x)
        TSL2591_GAIN_HIGH  = 0x20, // medium gain (428x)
        TSL2591_GAIN_MAX   = 0x30, // max gain (9876x)
    [ ] button cal code support
        USER_INPUT_HW_COEFF_STRUCT:
            F32 minimum_voltage_loop_a; // LOOP_A voltages below this number will be ignored.
            F32 minimum_voltage_loop_b; // voltages below this number will be ignored
            F32 button_range_lower;     // multiplier for a buttons lower limit
            F32 button_volts_up;        // voltage seen for UP button
            F32 button_volts_left;      // voltage seen for LEFT button
            F32 button_volts_mode;      // voltage seen for MODE button
            F32 button_volts_engage1;   // voltage seen for ENGAGE button #1
            F32 button_volts_down;      // voltage seen for DOWN button
            F32 button_volts_right;     // voltage seen for RIGHT button
            F32 button_volts_engage2;   // voltage seen for ENGAGE button #2
        USER_INPUT_COEFF_STRUCT:
            //switch coeff for non-eng/dis PCI buttons
            MOMENTARY_SWITCH_COEFF_STRUCT momentary_switch;
                U32 debounce_threshold; // Threshold, in frames, of the debounce time
                U32 sustain_threshold;  // Threshold, in frames, of the sustain time
                // Coefficients for the falling edge one-shot
                PERSISTENT1SHOT_COEFF_STRUCT switch_opened_one_shot_coeff;
                    U32 P;                // cycles of persistence
                    BOOLEAN ic;           // initial condition
                    BOOLEAN rising_edge;  // trigger on rising edge
                    BOOLEAN falling_edge; // trigger on falling edge
            //switch coeff for eng/dis buttons
            MOMENTARY_SWITCH_COEFF_STRUCT momentary_switch_eng_dis;
                U32 debounce_threshold; // Threshold, in frames, of the debounce time
                U32 sustain_threshold;  // Threshold, in frames, of the sustain time
                // Coefficients for the falling edge one-shot
                PERSISTENT1SHOT_COEFF_STRUCT switch_opened_one_shot_coeff;
                    U32 P;                // cycles of persistence
                    BOOLEAN ic;           // initial condition
                    BOOLEAN rising_edge;  // trigger on rising edge
                    BOOLEAN falling_edge; // trigger on falling edge
    [ ] dimmer cal code support
        st_ptr->annunciators_coeff.display_brightness_offset = 0.3f;
        st_ptr->annunciators_coeff.display_brightness_scaling = 1.0f;
        st_ptr->annunciators_coeff.ext_dimmer_low_pass_filter_alpha = 1.0f / 10.0f;
        st_ptr->annunciators_coeff.light_sensor_low_pass_filter_alpha = 1.0f / 200.0f;

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
accomplishments since march thru december:
added code to outer loop & inner loop: roll control, feedback
added unit tests: ReIntICHS, SatVF, RollCtrl
debugged simulator - blue board & STM
added script interface to mx app
modified attitude indicator to have airspeed & altitude: HdgHoldProf
automated rebuild of hap1 files on build
shrunk mfg code by abbreviating debug strings
debugged SHOW_FAULT_ENUMS
added override detection
merged envelope protection into devbr
debugged PCI button code
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
accomplishments starting december:
[x] added 3 JTAG blackhawks to helicopter for MCP programming

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[ ] ReIntICHS unit test - jeffs:
http://subversion.helitrak.com/svn/HAP1-CERT/branches/jeffrey/
    JeffsDevBr_HdgHoldProblem/SimModel/DEV/HLIB/ReInt/ReInt_ICHS_unitTest
    compare code with Jeffs model and matlab code
    run MatLab unit test
    run C unit test against csv

[ ] debug PFM release build on jenkins - repros locally -- bad relative path -- fixed(see logs)
        MCP succeeds
        ADP fails -- see logs m:\prj\PFM_debug --> now fails 
        "C:\helitrak\PFMReleaseBuildFix\SWDev\Tools\MX_Code\PersonalityFileMaker\
            PersonalityFileMaker\Serializer.h", 
        line 143: warning #562-D: "typeid" is reserved for future use as a keyword
        "C:\helitrak\PFMReleaseBuildFix\SWDev\Tools\MX_Code\PersonalityFileMaker\
            PersonalityFileMaker\Serializer.h", 
        line 143: error #256: type name is not allowed

[x] find arrays init'd with fault_enums -> in motor test - file pr
    => Actuator_Get_Fault_For_Code ==> hides FAULT_ENUMs
            FAULT_ENUM fault_type = Actuator_Get_Fault(&act_mod_tst->phase_struct);
            Fault_Mgmt_Set_Fault(fault_type);
        instead:
            FAULT_ENUM fault_type = Actuator_Set_Fault(&act_mod_tst->phase_struct);
                Fault_Mgmt_Set_Fault(fault_type);

[x] PR 3818: SHOW_FAULT_ENUMS option is not printing the enum string in all cases
    ==> create macro for these functions --> wrap all parms in ()
    [OL38_OverDet] Sensor_Mgmt.c::Sensor_Mgmt_Run_Sample_Rate_Sanity_Check
    [OL38_OverDet] Signals_ADP.c::Signals_Sensor_Update_Fault_Handling

[x] PR 2993: MfgTest builds are out of code space

[ ] ==> DevBrMfg <== C:\helitrak\MfgBuild
    [x] Signals_Sensor_Update_Fault_Handling <== needs to be macro
        Signals_ADP macro sensor faults => 0x12 & 0x14 ==> SHOW_FAULT_ENUMS
        => Fault_Mgmt_Set_Fault uses text of enum

[ ] code re-engagement design
    Op_Mode_Support_Run
        USER_INPUT_CMD_BITFLAGS median = User_Input_Get_Median_Cmd_Bitflags();//PCI buttons active
        if (engage_loop_1_pressed && engage_loop_2_pressed)
            System_Log_Increment_Engaged_Count();
            System_Log_Set_Flag(SYSFLAG_ENGAGED, TRUE);
            // Start engaging the clutches.
            => on engage in MCP : Actuator_Mgmt_Clutches_Engage
            Actuator_Mgmt_Clutches_Engage();
                Clutch_Control_Engage();
                am_state_ptr->engage_init_needed        = TRUE;
                am_state_ptr->override_braking_counter  = 0;
    also see outer_loop\mode_logic
    MCP_Set_Run(Actuator_Mgmt_Are_Clutches_Engaged()); => starts ADP running
    // ADP flies the helicopter: HDG_HOLD, ALT_HOLD, SPD_HOLD
    // how is ADP navigation notified of override?

[ ] discuss w/Tom the Light Sensor Auto Dimming feature

[ ] OL38_OverDet: see notes in override_detection project
    --> #ifdef experimental code
    -->   need to remember cyclic position and return when override is removed
    -->   create a runtime mapping of cyclic position[airspeed] for straight/level
    -->   start w/unit tests: 2d linterp + 2nd order switch (exp code)
    -->   assess code space savings
    --> #endif
    -> ADP pin for override detection
    -> zero point at engagement
    -> need monoStableFlipFlop (latch) MCP Post pin off for post so no alias
    -> 1 frame delay: Main_MCP: Actuator_Mgmt_Run + MCP_To_ADP_Service_ADP_In
    -> ADP:IPC_Construct_Message -> MCP:MCP_To_ADP_Process_ADP_Message 
                                 -> Actuator_Mgmt_Set_Override_Detected

[ ] PR 3576 Add CAN SVN spew to bartb\FTC_CPD_4_BR_SVN_SPEW => DEBUG and RELEASE mode
    find DOORS rqmt & runs in debug & release
[ ] PCI Cal debug: -> diff PCI calibrator w/three axis calibrator - diff dirs
[ ] fix coeff generators: ADP/MCP: hcoeff_adp_claw.m/hcoeff_mcp_claw.m
[ ] PR 3303 HAP1-SDD-ADP: Inter_Proc_Comm_ADP: 0.19- OID’s are of type ‘TBD’
    ==> schedule live CCB meeting for this one.

[>reqts] 3292 in Inter_Proc_Comm_MCP.h, malformed Requirement tag
    In http://subversion.helitrak.com/svn/HAP1-CERT/System/SWDev/MCP/Header/Inter_Proc_Comm_MCP.h
    /** ===========================================================================
    \struct  SYSTEM_IPC_POST_STRUCT
    \brief    Holds the CRC data passed in the data Ring Message for a single MCP.
              (data: 4 bytes)             
    \MCPReqt{HAP1-SDD-MCP,}
    Totally undefined, need to DD item in SDD-MCP

[>reqts] 3294 In Steam_IO_MCP.c, malformed Requirement tag
    In http://subversion.helitrak.com/svn/HAP1-CERT/System/SWDev/MCP/Source/Stream_IO_MCP.c
    /** ========================================================================
    \def FRAM1
    \brief Struct representing remote FRAM device #1
    \MCPReqt{HAP1-SDD-MCP,xxx}
    Totally undefined, need to DD item in SDD-MCP

[rdy4ccb] 2509 - Phase Timing: PR development tool: bartb/DevBrProfiler
    [ ] see PP files for macro troubleshooting
    [ ] save peer comments, prep for CCB
    [x] search for printf variants in autopilot
    add more comments
    chg: measured = phases[i].avg + (NUM_STD_DEV_SAMPLE*phases[i].stdev);
    absorb sola's utilization into profiler
    add unit tests

[ ] checkin coeffs
    -> SIM: trk prop    2.3375
            trk int     0.1450
            alt prop    0.0135
            alt int     0.0005
    -> FLT: trk prop    2.5375
            trk int     0.1250
            alt prop    ??????
            alt int     ??????

*** notes: COM6,uname:unamehelitrak
** @@ Main_MCP.c  -> Fault_Mgmt_Set_Fault(FAULT_MULTIPLE_LEVEL_THREE_FAULTS);
** @@ MCP_State.c -> Fault_Mgmt_Set_Fault(FAULT_MCP_POST);
5 new feats: new mag, spd comp fltr, tuning, cpd integ, override detect, trunk bld, dimmer cal
https://www.mediawiki.org/wiki/Help:Formatting
http://www.ircbeginner.com/ircinfo/ircc-commands.html <== webchat.freenode.net commands
mstsc:understand-pc -> software schedules
    open -> ( ) Y:\Project Management\Schedule\HAP1_Software_Schedule.mpp
PERS: RaspPi power supply, reader=http://bravegnu.org/gnu-eprog/

----------------- 
| a | b | c | d |
|---|---|---|---|
|( ]|( ]|[ )|[ )| checkin peer review
|( ]|( ]|[ )|[ )| checkin code change
|( ]|( ]|[ )|[ )| attach rqmts was/is doc to PR
|( ]|( ]|[ )|[ )| attach code links to PR
|( ]|( ]|[ )|[ )| add CCB questionnaire to PR
=================
|( ]|( ]|[ )|[ )| send batch eccb request
=================
|( ]|( ]|[ )|[ )| add rqmts to doors
|( ]|( ]|[ )|[ )| add tags to code
|( ]|( ]|[ )|[ )| recheck-in newly tagged code
|( ]|( ]|[ )|[ )| submit code changes to Ray for checkin
----------------- 

0========1=========2=========3=========4=========5=========6=========7=========8=========9=========0

accelerometer on mag board is not used - remove app code
mag/install/calibrate -> earth's mag field strength - dip angle vs down vector: noaa.org, 
                            helmholtz coil

fs01\helitrak\projectmgmt\schedule\helitrakschedule\R&D projects
    outer loop, ADAHRS, PR dispostion, flight tests, SIL
ARCH-OL -> Roll control :: diff DevBr and FTC 20

Reminder of where everything lives:
[ ] checkins:
    ConfigDumper CRCs -> TelemetryV2
    database for CRCs/Branch/Serial Numbers -> toys\py (sqlite)
        => F:\apps\DataLite\DataLite
    Phase timing -> bartb\FTC_CPD_4_BR
    Branch CAN spew -> bartb\HdgHold
    Eyes => -> TelemetryV2
    Fault calculator -> TelemetryV2
    Override detection -> OL38_OverDet
    Getter for calibration coeffs -> HdgHoldProf

http://www.hanselman.com/blog/ScottHanselmans2014UltimateDeveloperAndPowerUsersToolListForWindows.aspx

bartbh*k

SW Tools:
========
Download Log
Decode Error Codes (diagnose issues)
Clear Log
Installation Calibration
Add Manufacturing Calibration data to Matlab Test Script
Capture Debug Info (including startup messages, software version, etc.)
Installation Configuration/Test/Debug
Investigate reducing producing 3 MCP HAP personality files to a single HAP personality file.
[edit]Manufacturing Calibration Application
Manufacturing/Diagnostic POST Application
Add an option in the CoeffChanger for entering a value in degrees and having it convert to radians and set the value.
Add a display of the current value instead of having to look at the terminal printout to see the values.

