12/20/2016 2:23:48 PM     C:\code\report

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
summary to do:
[ ] IL test flights to assess need for gain sched: speed/alt/wt => IL tuning
[ ] coefficient builder
[ ] unit tests: roll control
[ ] ambient light cal: => y:ambient2.ino
[ ] HdgHoldCRC
[ ] merge mxapp => can_demux
[ ] SP & PP different tones : HdgHoldTone
[ ] LCD STM board

goals:
[ ] complete todo list for a/p cert: tools & estimates
[ ] requirements - diff trunk w/devbr
[ ] rs485
[ ] use feedback_run w/0 gain for 2nd integrator (pitch)
[ ] mcp overdet: full hardware support ...
[ ] button cal code support
[ ] dimmer cal code support

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[ ] Unit tests: creating CVS in HAP dir
    Transient Repro: SP into max turn rate => PP machine gun

    SimModel/HAP/Autopilot_ARCH_ADP_RollTargetGen.mdl
    SimModel/HAP/Autopilot_ARCH_ADP_RollTargetGen_UnitTest.slx

    unit_test.cpp:
        ut.Assign_Timestamp(COLUMN_0);
        ut.Assign_Run_Function(Roll_Target_Gen_Run);
        ut.Assign_Input (Roll_Target_Gen_Set_Phi,                   COLUMN_1);
        ut.Assign_Input (Roll_Target_Gen_Set_Psi,                   COLUMN_2);
        ut.Assign_Input (Roll_Target_Gen_Set_Psi_Dot,               COLUMN_3);
        ut.Assign_Input (Roll_Target_Gen_Set_Run,                   COLUMN_4);
        ut.Assign_Input (Roll_Target_Gen_Set_PCI_LNR_SP,            COLUMN_5);
        ut.Assign_Input (Roll_Target_Gen_Set_Heading_Setpoint_Bias, COLUMN_6);
        ut.Assign_Output(Roll_Target_Gen_Get_Psi_Target,            COLUMN_7);
        ut.Assign_Output(Roll_Target_Gen_Get_Psi_Dot_Target,        COLUMN_8);

    csv format: 
        oline = sprintf('%8.2f', single(simout_y1.Time(n)) );
        oline = sprintf(['%s,',fFMT,',%s'],  (simin_u1.Data(n));
        oline = sprintf(['%s,',bFMT,],       (simin_u2.Data(n));
        oline = sprintf(['%s,',fFMT,',%s'],  (simin_u3.Data(n));
        oline = sprintf(['%s,',bFMT,],       (simin_u4.Data(n));
      % oline = sprintf(['%s,',fFMT,',%s'],  (simin_u5.Data(n));
      % oline = sprintf(['%s,',fFMT,',%s'],  (simin_u6.Data(n));
        oline = sprintf(['%s,',fFMT,',%s'], (simout_y1.Data(n));
      % oline = sprintf(['%s,',bFMT,],      (simout_y2.Data(n));
      % oline = sprintf(['%s,',bFMT,],      (simout_y3.Data(n));
        otext{k} = sprintf('%s%s\n',otext{k},oline);

    input:
        F32 phi;                   // phi (rad)
        F32 psi;                   // psi (rad)
        F32 psi_dot;               // psi_dot (rad/sec)
        S8  pci_LNR_SP;            // Left/Right Sustained Press
        S8  pci_LNR_PP;            // Left/Right Pulse Press
        BOOLEAN run;               // TRUE to run, FALSE to reset.
        
    output:
        F32 psi_target;          // The output psi target
        F32 psi_dot_target;      // The output psi dot target
        
    coeffs:
        F32 Ts; // time for one step (1/100 s)
        F32 SP_psi_dot_ramp_rate;        // time to ramp to max psi dot (3s)
        F32 SP_WO_tau;                   // sets time for washout (5s)
        F32 SP_WO_phi_range;             // if phi < WO_phi_range, start washout
// if psi_dot_target < WO_psi_dot_min, close enough to zero to stop WO
        F32 SP_WO_psi_dot_min;
        F32 PP_delta_psi_zero_tolerance; // tolerance around zero for detecting almost level
        F32 PP_radperclick;              // gain for radians per click and conversion
//symmetrical saturation limits (positive and negative) for psi-dot-dot = 2degrees/s/s in radians
        F32 PP_psi_dot_dot;
        REINTICH_COEFF_STRUCT  reintICH_coeff;
            F32 K_Ts;   // gain * sample period
        REINTICHS_COEFF_STRUCT reintICHS_SP_coeff;
            F32 K_Ts;   // gain * sample period
            F32 Gain;
            F32 UL;							// copy of limit for saturation
            F32 LL;							// copy of limit for saturation
            F32 rail_bounce_divisor;		// ~1024.0f
            REINTICH_COEFF_STRUCT  integrator_coeff; // Rectangular integrator coefficient
                F32 K_Ts;   // gain * sample period
            SATURATIONVF_COEFF_STRUCT sat_coeff;  // Coefficients for saturation block
                F32 epsilon; // tolerance for comparing floats
                F32 upper_sat_limit;    // upper saturation limit
                F32 lower_sat_limit;    // lower saturation limit
        REINTICHS_COEFF_STRUCT reintICHS_PP_coeff;
            F32 K_Ts;   // gain * sample period
            F32 Gain;
            F32 UL;							// copy of limit for saturation
            F32 LL;							// copy of limit for saturation
            F32 rail_bounce_divisor;		// ~1024.0f
            REINTICH_COEFF_STRUCT  integrator_coeff; // Rectangular integrator coefficient
                F32 K_Ts;   // gain * sample period
            SATURATIONVF_COEFF_STRUCT sat_coeff;  // Coefficients for saturation block
                F32 epsilon; // tolerance for comparing floats
                F32 upper_sat_limit;    // upper saturation limit
                F32 lower_sat_limit;    // lower saturation limit

[ ] Goals
    [ ] complete todo list for a/p cert: tools & estimates
    [ ] requirements - diff trunk w/devbr
    [ ] rs485
    [ ] IL test flights to assess need for gain sched: speed/alt/wt => IL tuning
    [ ] use feedback_run w/0 gain for 2nd integrator (pitch)
    [ ] mcp overdet: full hardware support ...
    [ ] ambient light cal: => y:ambient2.ino
        ==> plot curves for each gain
        TSL2591_GAIN_LOW   = 0x00, // low gain (1x)
        TSL2591_GAIN_MED   = 0x10, // medium gain (25x)
        TSL2591_GAIN_HIGH  = 0x20, // medium gain (428x)
        TSL2591_GAIN_MAX   = 0x30, // max gain (9876x)
    [ ] button cal code support
        USER_INPUT_HW_COEFF_STRUCT:
            F32 minimum_voltage_loop_a; // LOOP_A voltages below this number will be ignored.
            F32 minimum_voltage_loop_b; // voltages below this number will be ignored
            F32 button_range_lower;     // multiplier for a buttons lower limit
            F32 button_volts_up;        // voltage seen for UP button
            F32 button_volts_left;      // voltage seen for LEFT button
            F32 button_volts_mode;      // voltage seen for MODE button
            F32 button_volts_engage1;   // voltage seen for ENGAGE button #1
            F32 button_volts_down;      // voltage seen for DOWN button
            F32 button_volts_right;     // voltage seen for RIGHT button
            F32 button_volts_engage2;   // voltage seen for ENGAGE button #2
        USER_INPUT_COEFF_STRUCT:
            //switch coeff for non-eng/dis PCI buttons
            MOMENTARY_SWITCH_COEFF_STRUCT momentary_switch;
                U32 debounce_threshold; // Threshold, in frames, of the debounce time
                U32 sustain_threshold;  // Threshold, in frames, of the sustain time
                // Coefficients for the falling edge one-shot
                PERSISTENT1SHOT_COEFF_STRUCT switch_opened_one_shot_coeff;
                    U32 P;				  // cycles of persistence
                    BOOLEAN ic; 	      // initial condition
                    BOOLEAN rising_edge;  // trigger on rising edge
                    BOOLEAN falling_edge; // trigger on falling edge
            //switch coeff for eng/dis buttons
            MOMENTARY_SWITCH_COEFF_STRUCT momentary_switch_eng_dis;
                U32 debounce_threshold; // Threshold, in frames, of the debounce time
                U32 sustain_threshold;  // Threshold, in frames, of the sustain time
                // Coefficients for the falling edge one-shot
                PERSISTENT1SHOT_COEFF_STRUCT switch_opened_one_shot_coeff;
                    U32 P;				  // cycles of persistence
                    BOOLEAN ic; 	      // initial condition
                    BOOLEAN rising_edge;  // trigger on rising edge
                    BOOLEAN falling_edge; // trigger on falling edge
    [ ] dimmer cal code support
        st_ptr->annunciators_coeff.display_brightness_offset = 0.3f;
        st_ptr->annunciators_coeff.display_brightness_scaling = 1.0f;
        st_ptr->annunciators_coeff.ext_dimmer_low_pass_filter_alpha = 1.0f / 10.0f;
        st_ptr->annunciators_coeff.light_sensor_low_pass_filter_alpha = 1.0f / 200.0f;


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
accomplishments since march:
added code to outer loop & inner loop: roll control, feedback
added unit tests: ReIntICHS, SatVF, RollCtrl
debugged simulator - blue board & STM
added script interface to mx app
modified attitude indicator to have airspeed & altitude
automated rebuild of hap1 files on build
shrunk mfg code by abbreviating debug strings
debugged SHOW_FAULT_ENUMS
added override detection
merged envelope protection into devbr
debugged PCI button code


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[ ] ReIntICHS unit test - jeffs:
http://subversion.helitrak.com/svn/HAP1-CERT/branches/jeffrey/
    JeffsDevBr_HdgHoldProblem/SimModel/DEV/HLIB/ReInt/ReInt_ICHS_unitTest
    compare code with Jeffs model and matlab code
    run MatLab unit test
    run C unit test against csv

[ ] Merge into HdgHold branch
    [ ] svn spew -> perl build              -> FTC_CPD_4_BR_SVN_SPEW
    [x] in_flight_tools                     -> this
    [ ] mfg fixes -> string compression     -> DevBrMfg
    [ ] override detection w/build target   -> OL38_OverDet

[ ] IL refactor:
    C code
    ======
    C:/helitrak/HdgHold/SWDev/MCP/Source/User_Input.c
    C:/helitrak/HdgHold/SWDev/Model/Inner_Loop/Source/Feedback.c
    C:/helitrak/HdgHold/SWDev/Model/Inner_Loop/Source/MCP_CLaw_coeff.c
    C:/helitrak/HdgHold/SWDev/Model/Inner_Loop/Source/Cyclic_Feedback.c
    C:/helitrak/HdgHold/SWDev/Model/Inner_Loop/Header/Cyclic_Feedback.h

    Matlab
    ======
    C:/helitrak/HdgHold/SimModel/HAP/Autopilot_ARCH_MCP_IL.mdl
    C:/helitrak/HdgHold/SimModel/HAP/Autopilot_ARCH_MCP_IL_CyclicFB.mdl
    C:/helitrak/HdgHold/SimModel/HAP/Autopilot_ARCH_MCP_SC.mdl
    C:/helitrak/HdgHold/SimModel/HAP/Autopilot_ARCH_MCP.mdl

    Notes:
    Add module TestPort Block and Unit Test (w/AES CanDemux, Mx_App) ServoController
        switch between: inner_loop_cmd & (inner_loop_cmd+step)


[ ] debug PFM release build on jenkins - repros locally -- bad relative path -- fixed(see logs)
        MCP succeeds
        ADP fails -- see logs m:\prj\PFM_debug --> now fails 
        "C:\helitrak\PFMReleaseBuildFix\SWDev\Tools\MX_Code\PersonalityFileMaker\
            PersonalityFileMaker\Serializer.h", 
        line 143: warning #562-D: "typeid" is reserved for future use as a keyword
        "C:\helitrak\PFMReleaseBuildFix\SWDev\Tools\MX_Code\PersonalityFileMaker\
            PersonalityFileMaker\Serializer.h", 
        line 143: error #256: type name is not allowed

[x] HdgHold: PSI offset: New telemetry to fix HDG wander/offset
    -> HDG roll rate, heading rate, current target and error
    -> ROLL target (s/b zero), error
    steps: 70 knots, S&L, 18" manifold pressure, engage
    repro: turns left about 10 deg
    thoughts: OL integrator coeff too low
              IL fighting OL
    setup: run attitude indicator app & print attitude Psi @ engage

[x] find arrays init'd with fault_enums -> in motor test - file pr
    => Actuator_Get_Fault_For_Code ==> hides FAULT_ENUMs
            FAULT_ENUM fault_type = Actuator_Get_Fault(&act_mod_tst->phase_struct);
            Fault_Mgmt_Set_Fault(fault_type);
        instead:
            FAULT_ENUM fault_type = Actuator_Set_Fault(&act_mod_tst->phase_struct);
                Fault_Mgmt_Set_Fault(fault_type);

[x] PR 3818: SHOW_FAULT_ENUMS option is not printing the enum string in all cases
    ==> create macro for these functions --> wrap all parms in ()
    [OL38_OverDet] Sensor_Mgmt.c::Sensor_Mgmt_Run_Sample_Rate_Sanity_Check
    [OL38_OverDet] Signals_ADP.c::Signals_Sensor_Update_Fault_Handling

[x] PR 2993: MfgTest builds are out of code space

[ ] debug spew from STMicro to debug console

[ ] ==> DevBrMfg <== C:\helitrak\MfgBuild
    [x] Signals_Sensor_Update_Fault_Handling <== needs to be macro
        Signals_ADP macro sensor faults => 0x12 & 0x14 ==> SHOW_FAULT_ENUMS
        => Fault_Mgmt_Set_Fault uses text of enum

[ ] code re-engagement design
    Op_Mode_Support_Run
        USER_INPUT_CMD_BITFLAGS median = User_Input_Get_Median_Cmd_Bitflags();//PCI buttons active
        if (engage_loop_1_pressed && engage_loop_2_pressed)
            System_Log_Increment_Engaged_Count();
            System_Log_Set_Flag(SYSFLAG_ENGAGED, TRUE);
            // Start engaging the clutches.
            => on engage in MCP : Actuator_Mgmt_Clutches_Engage
            Actuator_Mgmt_Clutches_Engage();
                Clutch_Control_Engage();
                am_state_ptr->engage_init_needed        = TRUE;
                am_state_ptr->override_braking_counter  = 0;
    also see outer_loop\mode_logic
    MCP_Set_Run(Actuator_Mgmt_Are_Clutches_Engaged()); => starts ADP running
    // ADP flies the helicopter: HDG_HOLD, ALT_HOLD, SPD_HOLD
    // how is ADP navigation notified of override?

[ ] discuss w/Tom the Light Sensor Auto Dimming feature

[ ] OL38_OverDet: see notes in override_detection project
    --> #ifdef experimental code
    -->   need to remember cyclic position and return when override is removed
    -->   create a runtime mapping of cyclic position[airspeed] for straight/level
    -->   start w/unit tests: 2d linterp + 2nd order switch (exp code)
    -->   assess code space savings
    --> #endif
    -> ADP pin for override detection
    -> zero point at engagement
    -> need monoStableFlipFlop (latch) MCP Post pin off for post so no alias
    -> 1 frame delay: Main_MCP: Actuator_Mgmt_Run + MCP_To_ADP_Service_ADP_In
    -> ADP:IPC_Construct_Message -> MCP:MCP_To_ADP_Process_ADP_Message 
                                 -> Actuator_Mgmt_Set_Override_Detected

[ ] Comp_Filter_Nth_Order: simplify to 1st, 2nd, 3rd order instances
    --> start w/unit tests

[ ] OL38_Merge_DevBr merged into main branch --> CCB should be done (see Bob)
    (Altitude hold envelope protection)
    + altitude comp filter  -> altitude hold
    + speed comp filter     -> speed hold
    + true air speed
    + vertical rate

[ ] PR 3576 Add CAN SVN spew to bartb\FTC_CPD_4_BR_SVN_SPEW => DEBUG and RELEASE mode
    find DOORS rqmt & runs in debug & release
[ ] PCI Cal debug: -> diff PCI calibrator w/three axis calibrator - diff dirs
[ ] fix coeff generators: ADP/MCP: hcoeff_adp_claw.m/hcoeff_mcp_claw.m
[ ] PR 3303 HAP1-SDD-ADP: Inter_Proc_Comm_ADP: 0.19- OID’s are of type ‘TBD’
    ==> schedule live CCB meeting for this one.

[>reqts] 3292 in Inter_Proc_Comm_MCP.h, malformed Requirement tag
    In http://subversion.helitrak.com/svn/HAP1-CERT/System/SWDev/MCP/Header/Inter_Proc_Comm_MCP.h
    /** ===========================================================================
    \struct  SYSTEM_IPC_POST_STRUCT
    \brief    Holds the CRC data passed in the data Ring Message for a single MCP.
              (data: 4 bytes)             
    \MCPReqt{HAP1-SDD-MCP,}
    Totally undefined, need to DD item in SDD-MCP

[>reqts] 3294 In Steam_IO_MCP.c, malformed Requirement tag
    In http://subversion.helitrak.com/svn/HAP1-CERT/System/SWDev/MCP/Source/Stream_IO_MCP.c
    /** ========================================================================
    \def FRAM1
    \brief Struct representing remote FRAM device #1
    \MCPReqt{HAP1-SDD-MCP,xxx}
    Totally undefined, need to DD item in SDD-MCP

[rdy4ccb] 2509 - Phase Timing: PR development tool: bartb/DevBrProfiler
    [ ] see PP files for macro troubleshooting
    [ ] save peer comments, prep for CCB
    [x] search for printf variants in autopilot
    add more comments
    chg: measured = phases[i].avg + (NUM_STD_DEV_SAMPLE*phases[i].stdev);
    absorb sola's utilization into profiler
    add unit tests

HAP Certification
    [x] ADAHRS ARCH Reqts : Jeffrey, Michael, Bart
    [ ] Outer Loop ARCH Reqts : Bart, Jeffrey
    [ ] Dimmer Calibration : Bart --> see Tom
    [ ] Altitude Hold Envelope Protection : Ray, Bart
    [ ] Speed Complementary Filter : Bart
    [ ] Altitude Complementary Filter : Bart
    [ ] PCI resistor update : Tom, Bart
    [ ] PCI Calibration : Samir
    [ ] Unit tests: 6 ADAHRS + 3 OL

[  ] Research for post-FLT039
    [ ] Add telemetry flags for limiters in OL pipeline
    [ ] 2 bits / flag (hi/low)
    [ ] file PR for this addition to telemetry
[ ] Research new feature
    [ ] vertical speed term - in gust - no push over (pitch)
    [ ] essentially a G-limit on OL pitch control -- see inner loop G-limiter
[ ] Outer Loop
    [ ] Env Prot -> Altitude hold mode
    [ ] Hdg Comp Fltr : 15 days
    [ ] Roll Control  : test harness
        [ ] Matlab
        [ ] Unittest - hand generated vectors (sinewave) match autopilot w/model
[ ] audit of board serialization process
[ ] checkin coeffs
    -> SIM: trk prop    2.3375
            trk int     0.1450
            alt prop    0.0135
            alt int     0.0005
    -> FLT: trk prop    2.5375
            trk int     0.1250
            alt prop    ??????
            alt int     ??????
[ ] debug coeff_builders && trace outer loop Gains => sample time mismatches --> +ZOHs

*** notes: COM6,uname:unamehelitrak
** @@ Main_MCP.c  -> Fault_Mgmt_Set_Fault(FAULT_MULTIPLE_LEVEL_THREE_FAULTS);
** @@ MCP_State.c -> Fault_Mgmt_Set_Fault(FAULT_MCP_POST);
5 new feats: new mag, spd comp fltr, tuning, cpd integ, override detect, trunk bld, dimmer cal
https://www.mediawiki.org/wiki/Help:Formatting
http://www.ircbeginner.com/ircinfo/ircc-commands.html <== webchat.freenode.net commands
mstsc:understand-pc -> software schedules
    open -> ( ) Y:\Project Management\Schedule\HAP1_Software_Schedule.mpp
PERS: RaspPi power supply, reader=http://bravegnu.org/gnu-eprog/
0========1=========2=========3=========4=========5=========6=========7=========8=========9=========0

accelerometer on mag board is not used - remove app code
mag/install/calibrate -> earth's mag field strength - dip angle vs down vector: noaa.org, 
                            helmholtz coil

fs01\helitrak\projectmgmt\schedule\helitrakschedule\R&D projects
    outer loop, ADAHRS, PR dispostion, flight tests, SIL
ARCH-OL -> Roll control :: diff DevBr and FTC 20

Reminder of where everything lives:
[ ] checkins:
    ConfigDumper CRCs -> TelemetryV2
    database for CRCs/Branch/Serial Numbers -> toys\py (sqlite)
        => F:\apps\DataLite\DataLite
    Phase timing -> bartb\FTC_CPD_4_BR
    Branch CAN spew -> bartb\FTC_CPD_4_BR (requires perl & svn)
    Eyes => -> TelemetryV2
    Fault calculator -> TelemetryV2
    Override detection -> OL38_OverDet

http://www.hanselman.com/blog/ScottHanselmans2014UltimateDeveloperAndPowerUsersToolListForWindows.aspx

bartbh*k
